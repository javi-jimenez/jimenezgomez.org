kind: pipeline
type: docker
name: default

steps:
  - name: build
    image: klakegg/hugo:0.113.0-ext-alpine
    commands:
      - hugo --minify

  - name: deploy
    image: alpine:3.18
    environment:
      FTP_HOST:
        from_secret: FTP_HOST
      FTP_USER:
        from_secret: FTP_USER
      FTP_PASSWORD:
        from_secret: FTP_PASSWORD
      FTP_REMOTE_PATH:
        from_secret: FTP_REMOTE_PATH
    commands:
      - apk add --no-cache lftp
      - |
        if [ -z "${FTP_HOST}" ] || [ -z "${FTP_USER}" ] || [ -z "${FTP_PASSWORD}" ]; then
          echo "FTP credentials not provided; skipping deploy"
          exit 0
        fi
      - |
        lftp -u "${FTP_USER}","${FTP_PASSWORD}" "${FTP_HOST}" -e "mirror -R public ${FTP_REMOTE_PATH} --delete --verbose; bye"

trigger:
  branch:
    - main
kind: pipeline
type: docker
name: Deploy Hugo Blog

trigger:
  branch:
    - main
  event:
    - push

steps:
  - name: Build Docker Image
    image: docker:latest
    volumes:
      - name: docker
        path: /var/run/docker.sock
    commands:
      - docker build -t jimenezgomez-blog:${DRONE_COMMIT_SHA:0:8} .
      - docker tag jimenezgomez-blog:${DRONE_COMMIT_SHA:0:8} jimenezgomez-blog:latest

  - name: Deploy to OVH via FTP
    image: alpine:latest
    environment:
      FTP_SERVER:
        from_secret: ftp_server
      FTP_USERNAME:
        from_secret: ftp_username
      FTP_PASSWORD:
        from_secret: ftp_password
    commands:
      - apk add --no-cache lftp
      - |
        lftp -e "
        set ftp:ssl-allow false
        open -u $${FTP_USERNAME},$${FTP_PASSWORD} $${FTP_SERVER}
        mirror -R --delete public/ /jimenezgomez.org/
        quit
        " 2>&1 || true

  - name: Notify Deployment
    image: alpine:latest
    commands:
      - echo "âœ… Deployment completed for commit ${DRONE_COMMIT_SHA:0:8}"

volumes:
  - name: docker
    host:
      path: /var/run/docker.sock
