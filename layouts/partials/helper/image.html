{{/*
  Site override for image helper.
  Behavior:
  - Prefer .Params.image if set (external URL or page bundle resource or relative path)
  - If not set, fall back to the first page resource image (from page bundle / page resources)
  - If still not found, check site defaultImage per type (as theme does)
*/}}
{{ $result := dict "exists" false "permalink" nil "resource" nil "isDefault" false }}
{{ $imageField := default "image" .Site.Params.featuredImageField }}
{{ $imageValue := index .Params $imageField }}

{{ if $imageValue }}
    {{ $result = merge $result (dict "exists" true) }}
    {{ $url := urls.Parse $imageValue }}

    {{ if or (eq $url.Scheme "http") (eq $url.Scheme "https") }}
        {{ $result = merge $result (dict "permalink" $imageValue) }}
    {{ else }}
        {{ $pageResourceImage := .Resources.GetMatch (printf "%s" ($imageValue | safeURL)) }}
        {{ if $pageResourceImage }}
            {{ $result = merge $result (dict "permalink" $pageResourceImage.RelPermalink) }}
            {{ if ne (path.Ext $imageValue) ".svg" }}
                {{ $result = merge $result (dict "resource" $pageResourceImage) }}
            {{ end }}
        {{ else }}
            {{ $result = merge $result (dict "permalink" (relURL $imageValue)) }}
        {{ end }}
    {{ end }}

{{ else }}
    {{/* Fallback: if the page has resources of type image, use the first one */}}
    {{/* Prefer a generated thumbnail if present */}}
    {{ $thumb := .Resources.GetMatch "og-image-600x315.*" }}
    {{ if $thumb }}
        {{ $result = merge $result (dict "exists" true "permalink" $thumb.RelPermalink "resource" $thumb) }}
    {{ else }}
        {{ $imgs := .Resources.ByType "image" }}
        {{ if $imgs }}
            {{ if gt (len $imgs) 0 }}
                {{ $first := index $imgs 0 }}
                {{ $result = merge $result (dict "exists" true "permalink" $first.RelPermalink "resource" $first) }}
            {{ end }}
        {{ end }}
    {{ end }}
    {{ if not $result.exists }}
        {{ if and (ne .Type nil) (index .Site.Params.defaultImage .Type) }}
            {{ $defaultImageSetting := index .Site.Params.defaultImage .Type }}
            {{ if $defaultImageSetting.enabled }}
                {{ $result = merge $result (dict "isDefault" true) }}
                {{ $result = merge $result (dict "exists" true) }}
                {{ if $defaultImageSetting.local }}
                    {{ $siteResourceImage := resources.GetMatch (printf "%s" ($defaultImageSetting.src | safeURL)) }}
                    {{ if $siteResourceImage }}
                        {{ $result = merge $result (dict "permalink" $siteResourceImage.RelPermalink) }}
                        {{ $result = merge $result (dict "resource" $siteResourceImage) }}
                    {{ else }}
                        {{ errorf "Failed loading image: %q" $defaultImageSetting.src }}
                        {{ $result = merge $result (dict "exists" false) }}
                    {{ end }}
                {{ else }}
                    {{ $result = merge $result (dict "permalink" (relURL $defaultImageSetting.src)) }}
                {{ end }}
            {{ end }}
        {{ end }}
    {{ end }}
    
{{ end }}

{{ return $result }}
